<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/svg+xml" href="/assets/favicon-01739711.svg" />
    
    
    
    <link rel="stylesheet" href="/assets/style-f855e479.css">
  <title>Server-Side Rendering</title></head>
  <body> <a class="sr-only" href="#server-side-rendering">Skip to content</a> <div class="flex md:w-fit md:mx-auto"><nav id="toc" tabindex="-1" class="bg-slate-100 sr-only focus-within:not-sr-only focus-within:fixed focus-within:top-0 focus-within:left-0 focus-within:h-screen focus-within:w-64 focus-within:px-8 lg:not-sr-only lg:h-screen lg:w-64 lg:px-8 lg:!sticky lg:top-0 lg:left-0 lg:shrink-0 lg:shadow-[-99999px_0_0_99999px] lg:shadow-slate-100"><div class="sticky top-0"><a href="/" class="text-xl py-4 flex items-center border-b border-b-slate-300 " aria-hidden><img src="/assets/favicon-01739711.svg" alt="logo" width="32" height="32"> <span class="tracking-wide ml-2 text-slate-800" data-svelte-h="svelte-1hbur4j">Svelte Pilot</span></a> <ul class="py-4"><li class="mb-4"><span class="font-semibold text-slate-500 tracking-wider uppercase">Guide</span> <ul><li class="my-2"><a href="/en/introduction" class="text-slate-700 ">Introduction</a> </li><li class="my-2"><a href="/en/creating-a-project" class="text-slate-700 ">Creating a Project</a> </li><li class="my-2"><a href="/en/routing" class="text-slate-700 ">Routing</a> </li><li class="my-2"><a href="/en/ssr" class="text-slate-700 font-semibold !text-[#FF3E00]">Server-Side Rendering</a> </li><li class="my-2"><a href="/en/template" class="text-slate-700 ">Template</a> </li></ul> </li><li class="mb-4"><span class="font-semibold text-slate-500 tracking-wider uppercase">Components</span> <ul><li class="my-2"><a href="/en/link" class="text-slate-700 ">&lt;Link></a> </li><li class="my-2"><a href="/en/client-app" class="text-slate-700 ">&lt;ClientApp></a> </li><li class="my-2"><a href="/en/server-app" class="text-slate-700 ">&lt;ServerApp></a> </li></ul> </li><li class="mb-4"><span class="font-semibold text-slate-500 tracking-wider uppercase">API</span> <ul><li class="my-2"><a href="/en/router" class="text-slate-700 ">Router</a> </li></ul> </li></ul></div></nav> <main class="max-w-3xl min-w-0 p-4 sm:p-6 md:p-8"><div class="mb-4 flex justify-between"><div data-svelte-h="svelte-1y34zl4"><a href="#toc" aria-hidden class="lg:hidden"><svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 -960 960 960" width="24"><path d="M120-240v-80h720v80H120Zm0-200v-80h720v80H120Zm0-200v-80h720v80H120Z"></path></svg></a></div> <div><a href="/zh-CN/ssr" class="text-[#FF3E00] ">中文</a></div></div>    <article class="prose prose-slate max-w-none prose-a:text-[#FF3E00] prose-code:before:content-none prose-code:after:content-none prose-code:bg-slate-100 prose-code:inline-block prose-code:rounded prose-code:px-1"><!-- HTML_TAG_START --><h1 id="server-side-rendering">Server-Side Rendering</h1>
<p>In this chapter, based on the project created in the <a href="creating-a-project">Creating a Project</a> chapter, we will introduce how to implement server-side rendering using Svelte Pilot.</p>
<h2 id="code-structure">Code Structure</h2>
<p>The main code structure for SSR is as follows:</p>
<pre class="not-prose overflow-auto p-4 leading-normal rounded" style="background-color: #1E1E1E" tabindex="0"><code><span class="line"><span style="color: #D4D4D4">- index.html</span></span>
<span class="line"><span style="color: #D4D4D4">- ssr-dev-server.js    // HTTP service for the development environment</span></span>
<span class="line"><span style="color: #D4D4D4">- src/</span></span>
<span class="line"><span style="color: #D4D4D4">  - render.js          // Server-side renderer</span></span>
<span class="line"><span style="color: #D4D4D4">  - server.js          // Server entry point</span></span>
<span class="line"><span style="color: #D4D4D4">  - main.js            // Client entry point</span></span></code></pre><h2 id="development-server">Development Server</h2>
<p>In the development environment, we need an HTTP service to provide SSR and HMR (Hot Module Replacement) features. Example:</p>

<div class="my-5">
  <div class="text-white bg-zinc-800 rounded-t py-1 px-3">ssr-dev-server.js</div>
  <pre class="not-prose overflow-auto p-4 leading-normal rounded-b" style="background-color: #1E1E1E" tabindex="0"><code><span class="line"><span style="color: #C586C0">import</span><span style="color: #D4D4D4"> </span><span style="color: #9CDCFE">fs</span><span style="color: #D4D4D4"> </span><span style="color: #C586C0">from</span><span style="color: #D4D4D4"> </span><span style="color: #CE9178">&#39;fs&#39;</span></span>
<span class="line"><span style="color: #C586C0">import</span><span style="color: #D4D4D4"> { </span><span style="color: #9CDCFE">createServer</span><span style="color: #D4D4D4"> } </span><span style="color: #C586C0">from</span><span style="color: #D4D4D4"> </span><span style="color: #CE9178">&#39;http&#39;</span></span>
<span class="line"><span style="color: #C586C0">import</span><span style="color: #D4D4D4"> { </span><span style="color: #9CDCFE">createServer</span><span style="color: #D4D4D4"> </span><span style="color: #C586C0">as</span><span style="color: #D4D4D4"> </span><span style="color: #9CDCFE">createViteDevServer</span><span style="color: #D4D4D4"> } </span><span style="color: #C586C0">from</span><span style="color: #D4D4D4"> </span><span style="color: #CE9178">&#39;vite&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #569CD6">const</span><span style="color: #D4D4D4"> </span><span style="color: #4FC1FF">PORT</span><span style="color: #D4D4D4"> = </span><span style="color: #DCDCAA">Number</span><span style="color: #D4D4D4">(</span><span style="color: #9CDCFE">process</span><span style="color: #D4D4D4">.</span><span style="color: #9CDCFE">env</span><span style="color: #D4D4D4">.</span><span style="color: #4FC1FF">PORT</span><span style="color: #D4D4D4">) || </span><span style="color: #B5CEA8">5173</span></span>
<span class="line"></span>
<span class="line"><span style="color: #569CD6">const</span><span style="color: #D4D4D4"> </span><span style="color: #4FC1FF">vite</span><span style="color: #D4D4D4"> = </span><span style="color: #C586C0">await</span><span style="color: #D4D4D4"> </span><span style="color: #DCDCAA">createViteDevServer</span><span style="color: #D4D4D4">({</span></span>
<span class="line"><span style="color: #D4D4D4">  </span><span style="color: #9CDCFE">server:</span><span style="color: #D4D4D4"> { </span><span style="color: #9CDCFE">middlewareMode:</span><span style="color: #D4D4D4"> </span><span style="color: #569CD6">true</span><span style="color: #D4D4D4"> },</span></span>
<span class="line"><span style="color: #D4D4D4">  </span><span style="color: #9CDCFE">appType:</span><span style="color: #D4D4D4"> </span><span style="color: #CE9178">&#39;custom&#39;</span></span>
<span class="line"><span style="color: #D4D4D4">})</span></span>
<span class="line"></span>
<span class="line"><span style="color: #DCDCAA">createServer</span><span style="color: #D4D4D4">((</span><span style="color: #9CDCFE">req</span><span style="color: #D4D4D4">, </span><span style="color: #9CDCFE">res</span><span style="color: #D4D4D4">) </span><span style="color: #569CD6">=&gt;</span><span style="color: #D4D4D4"> {</span></span>
<span class="line"><span style="color: #D4D4D4">  </span><span style="color: #9CDCFE">vite</span><span style="color: #D4D4D4">.</span><span style="color: #DCDCAA">middlewares</span><span style="color: #D4D4D4">(</span><span style="color: #9CDCFE">req</span><span style="color: #D4D4D4">, </span><span style="color: #9CDCFE">res</span><span style="color: #D4D4D4">, </span><span style="color: #569CD6">async</span><span style="color: #D4D4D4"> () </span><span style="color: #569CD6">=&gt;</span><span style="color: #D4D4D4"> {</span></span>
<span class="line"><span style="color: #D4D4D4">    </span><span style="color: #C586C0">try</span><span style="color: #D4D4D4"> {</span></span>
<span class="line"><span style="color: #D4D4D4">      </span><span style="color: #6A9955">// 1. Read index.html</span></span>
<span class="line"><span style="color: #D4D4D4">      </span><span style="color: #569CD6">let</span><span style="color: #D4D4D4"> </span><span style="color: #9CDCFE">template</span><span style="color: #D4D4D4"> = </span><span style="color: #9CDCFE">fs</span><span style="color: #D4D4D4">.</span><span style="color: #DCDCAA">readFileSync</span><span style="color: #D4D4D4">(</span><span style="color: #CE9178">&#39;index.html&#39;</span><span style="color: #D4D4D4">, </span><span style="color: #CE9178">&#39;utf-8&#39;</span><span style="color: #D4D4D4">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D4D4D4">      </span><span style="color: #6A9955">// 2. Apply Vite HTML transforms. This injects the Vite HMR client,</span></span>
<span class="line"><span style="color: #D4D4D4">      </span><span style="color: #6A9955">//    and also applies HTML transforms from Vite plugins, e.g. global</span></span>
<span class="line"><span style="color: #D4D4D4">      </span><span style="color: #6A9955">//    preambles from @vitejs/plugin-react</span></span>
<span class="line"><span style="color: #D4D4D4">      </span><span style="color: #9CDCFE">template</span><span style="color: #D4D4D4"> = </span><span style="color: #C586C0">await</span><span style="color: #D4D4D4"> </span><span style="color: #9CDCFE">vite</span><span style="color: #D4D4D4">.</span><span style="color: #DCDCAA">transformIndexHtml</span><span style="color: #D4D4D4">(</span><span style="color: #9CDCFE">req</span><span style="color: #D4D4D4">.</span><span style="color: #9CDCFE">url</span><span style="color: #D4D4D4">, </span><span style="color: #9CDCFE">template</span><span style="color: #D4D4D4">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D4D4D4">      </span><span style="color: #6A9955">// 3. Load the server entry. ssrLoadModule automatically transforms</span></span>
<span class="line"><span style="color: #D4D4D4">      </span><span style="color: #6A9955">//    ESM source code to be usable in Node.js! There is no bundling</span></span>
<span class="line"><span style="color: #D4D4D4">      </span><span style="color: #6A9955">//    required, and provides efficient invalidation similar to HMR.</span></span>
<span class="line"><span style="color: #D4D4D4">      </span><span style="color: #569CD6">const</span><span style="color: #D4D4D4"> { </span><span style="color: #9CDCFE">default</span><span style="color: #D4D4D4">: </span><span style="color: #4FC1FF">render</span><span style="color: #D4D4D4"> } = </span><span style="color: #C586C0">await</span><span style="color: #D4D4D4"> </span><span style="color: #9CDCFE">vite</span><span style="color: #D4D4D4">.</span><span style="color: #DCDCAA">ssrLoadModule</span><span style="color: #D4D4D4">(</span><span style="color: #CE9178">&#39;/src/render.ts&#39;</span><span style="color: #D4D4D4">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D4D4D4">      </span><span style="color: #6A9955">// 4. render the app HTML. This assumes entry-server.js&#39;s exported</span></span>
<span class="line"><span style="color: #D4D4D4">      </span><span style="color: #6A9955">//     `render` function calls appropriate framework SSR APIs,</span></span>
<span class="line"><span style="color: #D4D4D4">      </span><span style="color: #6A9955">//    e.g. ReactDOMServer.renderToString()</span></span>
<span class="line"><span style="color: #D4D4D4">      </span><span style="color: #569CD6">const</span><span style="color: #D4D4D4"> {</span></span>
<span class="line"><span style="color: #D4D4D4">        </span><span style="color: #4FC1FF">statusCode</span><span style="color: #D4D4D4"> = </span><span style="color: #B5CEA8">200</span><span style="color: #D4D4D4">,</span></span>
<span class="line"><span style="color: #D4D4D4">        </span><span style="color: #4FC1FF">statusMessage</span><span style="color: #D4D4D4">,</span></span>
<span class="line"><span style="color: #D4D4D4">        </span><span style="color: #4FC1FF">headers</span><span style="color: #D4D4D4">,</span></span>
<span class="line"><span style="color: #D4D4D4">        </span><span style="color: #4FC1FF">body</span></span>
<span class="line"><span style="color: #D4D4D4">      } = </span><span style="color: #C586C0">await</span><span style="color: #D4D4D4"> </span><span style="color: #DCDCAA">render</span><span style="color: #D4D4D4">({</span></span>
<span class="line"><span style="color: #D4D4D4">        </span><span style="color: #9CDCFE">url:</span><span style="color: #D4D4D4"> </span><span style="color: #9CDCFE">req</span><span style="color: #D4D4D4">.</span><span style="color: #9CDCFE">url</span><span style="color: #D4D4D4">,</span></span>
<span class="line"><span style="color: #D4D4D4">        </span><span style="color: #9CDCFE">template</span><span style="color: #D4D4D4">,</span></span>
<span class="line"><span style="color: #D4D4D4">        </span><span style="color: #9CDCFE">headers:</span><span style="color: #D4D4D4"> </span><span style="color: #9CDCFE">req</span><span style="color: #D4D4D4">.</span><span style="color: #9CDCFE">headers</span></span>
<span class="line"><span style="color: #D4D4D4">      })</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D4D4D4">      </span><span style="color: #9CDCFE">res</span><span style="color: #D4D4D4">.</span><span style="color: #DCDCAA">writeHead</span><span style="color: #D4D4D4">(</span><span style="color: #9CDCFE">statusCode</span><span style="color: #D4D4D4">, </span><span style="color: #9CDCFE">statusMessage</span><span style="color: #D4D4D4">, </span><span style="color: #9CDCFE">headers</span><span style="color: #D4D4D4">)</span></span>
<span class="line"><span style="color: #D4D4D4">      </span><span style="color: #9CDCFE">res</span><span style="color: #D4D4D4">.</span><span style="color: #DCDCAA">end</span><span style="color: #D4D4D4">(</span><span style="color: #9CDCFE">body</span><span style="color: #D4D4D4">)</span></span>
<span class="line"><span style="color: #D4D4D4">    } </span><span style="color: #C586C0">catch</span><span style="color: #D4D4D4"> (</span><span style="color: #9CDCFE">e</span><span style="color: #D4D4D4">) {</span></span>
<span class="line"><span style="color: #D4D4D4">      </span><span style="color: #6A9955">// If an error is caught, let Vite fix the stack trace so it maps back</span></span>
<span class="line"><span style="color: #D4D4D4">      </span><span style="color: #6A9955">// to your actual source code.</span></span>
<span class="line"><span style="color: #D4D4D4">      </span><span style="color: #9CDCFE">vite</span><span style="color: #D4D4D4">.</span><span style="color: #DCDCAA">ssrFixStacktrace</span><span style="color: #D4D4D4">(</span><span style="color: #9CDCFE">e</span><span style="color: #D4D4D4">)</span></span>
<span class="line"><span style="color: #D4D4D4">      </span><span style="color: #9CDCFE">console</span><span style="color: #D4D4D4">.</span><span style="color: #DCDCAA">error</span><span style="color: #D4D4D4">(</span><span style="color: #9CDCFE">e</span><span style="color: #D4D4D4">)</span></span>
<span class="line"><span style="color: #D4D4D4">      </span><span style="color: #9CDCFE">res</span><span style="color: #D4D4D4">.</span><span style="color: #DCDCAA">writeHead</span><span style="color: #D4D4D4">(</span><span style="color: #B5CEA8">500</span><span style="color: #D4D4D4">, { </span><span style="color: #CE9178">&#39;Content-Type&#39;</span><span style="color: #9CDCFE">:</span><span style="color: #D4D4D4"> </span><span style="color: #CE9178">&#39;text/plain&#39;</span><span style="color: #D4D4D4"> })</span></span>
<span class="line"><span style="color: #D4D4D4">      </span><span style="color: #9CDCFE">res</span><span style="color: #D4D4D4">.</span><span style="color: #DCDCAA">end</span><span style="color: #D4D4D4">(</span><span style="color: #9CDCFE">e</span><span style="color: #D4D4D4">.</span><span style="color: #9CDCFE">message</span><span style="color: #D4D4D4">)</span></span>
<span class="line"><span style="color: #D4D4D4">    }</span></span>
<span class="line"><span style="color: #D4D4D4">  })</span></span>
<span class="line"><span style="color: #D4D4D4">}).</span><span style="color: #DCDCAA">listen</span><span style="color: #D4D4D4">(</span><span style="color: #4FC1FF">PORT</span><span style="color: #D4D4D4">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #9CDCFE">console</span><span style="color: #D4D4D4">.</span><span style="color: #DCDCAA">log</span><span style="color: #D4D4D4">(</span><span style="color: #CE9178">`Server running at http://localhost:</span><span style="color: #569CD6">${</span><span style="color: #4FC1FF">PORT</span><span style="color: #569CD6">}</span><span style="color: #CE9178">`</span><span style="color: #D4D4D4">)</span></span></code></pre>
</div><h2 id="server-side-renderer">Server-Side Renderer</h2>

<div class="my-5">
  <div class="text-white bg-zinc-800 rounded-t py-1 px-3">src/render.js</div>
  <pre class="not-prose overflow-auto p-4 leading-normal rounded-b" style="background-color: #1E1E1E" tabindex="0"><code><span class="line"><span style="color: #C586C0">import</span><span style="color: #D4D4D4"> { </span><span style="color: #9CDCFE">ServerApp</span><span style="color: #D4D4D4"> } </span><span style="color: #C586C0">from</span><span style="color: #D4D4D4"> </span><span style="color: #CE9178">&#39;svelte-pilot&#39;</span></span>
<span class="line"><span style="color: #C586C0">import</span><span style="color: #D4D4D4"> </span><span style="color: #9CDCFE">router</span><span style="color: #D4D4D4"> </span><span style="color: #C586C0">from</span><span style="color: #D4D4D4"> </span><span style="color: #CE9178">&#39;./router&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #C586C0">export</span><span style="color: #D4D4D4"> </span><span style="color: #C586C0">default</span><span style="color: #D4D4D4"> </span><span style="color: #569CD6">async</span><span style="color: #D4D4D4"> </span><span style="color: #569CD6">function</span><span style="color: #D4D4D4"> </span><span style="color: #DCDCAA">render</span><span style="color: #D4D4D4">({ </span><span style="color: #9CDCFE">url</span><span style="color: #D4D4D4">, </span><span style="color: #9CDCFE">template</span><span style="color: #D4D4D4"> }) {</span></span>
<span class="line"><span style="color: #D4D4D4">  </span><span style="color: #C586C0">try</span><span style="color: #D4D4D4"> {</span></span>
<span class="line"><span style="color: #D4D4D4">    </span><span style="color: #569CD6">const</span><span style="color: #D4D4D4"> </span><span style="color: #4FC1FF">route</span><span style="color: #D4D4D4"> = </span><span style="color: #C586C0">await</span><span style="color: #D4D4D4"> </span><span style="color: #9CDCFE">router</span><span style="color: #D4D4D4">.</span><span style="color: #DCDCAA">handleServer</span><span style="color: #D4D4D4">(</span></span>
<span class="line"><span style="color: #D4D4D4">      </span><span style="color: #569CD6">new</span><span style="color: #D4D4D4"> </span><span style="color: #DCDCAA">URL</span><span style="color: #D4D4D4">(</span><span style="color: #9CDCFE">url</span><span style="color: #D4D4D4">, </span><span style="color: #CE9178">&#39;http://127.0.0.1&#39;</span><span style="color: #D4D4D4">).</span><span style="color: #9CDCFE">href</span></span>
<span class="line"><span style="color: #D4D4D4">    )</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D4D4D4">    </span><span style="color: #C586C0">if</span><span style="color: #D4D4D4"> (!</span><span style="color: #9CDCFE">route</span><span style="color: #D4D4D4">) {</span></span>
<span class="line"><span style="color: #D4D4D4">      </span><span style="color: #C586C0">return</span><span style="color: #D4D4D4"> {</span></span>
<span class="line"><span style="color: #D4D4D4">        </span><span style="color: #9CDCFE">statusCode:</span><span style="color: #D4D4D4"> </span><span style="color: #B5CEA8">404</span><span style="color: #D4D4D4">,</span></span>
<span class="line"><span style="color: #D4D4D4">        </span><span style="color: #9CDCFE">body:</span><span style="color: #D4D4D4"> </span><span style="color: #C586C0">import</span><span style="color: #D4D4D4">.</span><span style="color: #9CDCFE">meta</span><span style="color: #D4D4D4">.</span><span style="color: #9CDCFE">env</span><span style="color: #D4D4D4">.</span><span style="color: #4FC1FF">DEV</span></span>
<span class="line"><span style="color: #D4D4D4">          ? </span><span style="color: #CE9178">`</span><span style="color: #569CD6">${</span><span style="color: #9CDCFE">url</span><span style="color: #569CD6">}</span><span style="color: #CE9178"> did not match any routes. Did you forget to add a catch-all route?`</span></span>
<span class="line"><span style="color: #D4D4D4">          : </span><span style="color: #CE9178">&#39;404 Not Found&#39;</span></span>
<span class="line"><span style="color: #D4D4D4">      }</span></span>
<span class="line"><span style="color: #D4D4D4">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D4D4D4">    </span><span style="color: #569CD6">const</span><span style="color: #D4D4D4"> </span><span style="color: #4FC1FF">body</span><span style="color: #D4D4D4"> = </span><span style="color: #9CDCFE">ServerApp</span><span style="color: #D4D4D4">.</span><span style="color: #DCDCAA">render</span><span style="color: #D4D4D4">({ </span><span style="color: #9CDCFE">router</span><span style="color: #D4D4D4">, </span><span style="color: #9CDCFE">route</span><span style="color: #D4D4D4"> })</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D4D4D4">    </span><span style="color: #C586C0">return</span><span style="color: #D4D4D4"> {</span></span>
<span class="line"><span style="color: #D4D4D4">      </span><span style="color: #9CDCFE">statusCode:</span><span style="color: #D4D4D4"> </span><span style="color: #B5CEA8">200</span><span style="color: #D4D4D4">,</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D4D4D4">      </span><span style="color: #9CDCFE">headers:</span><span style="color: #D4D4D4"> {</span></span>
<span class="line"><span style="color: #D4D4D4">        </span><span style="color: #CE9178">&#39;Content-Type&#39;</span><span style="color: #9CDCFE">:</span><span style="color: #D4D4D4"> </span><span style="color: #CE9178">&#39;text/html&#39;</span></span>
<span class="line"><span style="color: #D4D4D4">      },</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D4D4D4">      </span><span style="color: #9CDCFE">body:</span><span style="color: #D4D4D4"> </span><span style="color: #9CDCFE">template</span></span>
<span class="line"><span style="color: #D4D4D4">        .</span><span style="color: #DCDCAA">replace</span><span style="color: #D4D4D4">(</span><span style="color: #CE9178">&#39;&lt;/head&gt;&#39;</span><span style="color: #D4D4D4">, </span><span style="color: #9CDCFE">body</span><span style="color: #D4D4D4">.</span><span style="color: #9CDCFE">head</span><span style="color: #D4D4D4"> + </span><span style="color: #CE9178">&#39;&lt;/head&gt;&#39;</span><span style="color: #D4D4D4">)</span></span>
<span class="line"><span style="color: #D4D4D4">        .</span><span style="color: #DCDCAA">replace</span><span style="color: #D4D4D4">(</span></span>
<span class="line"><span style="color: #D4D4D4">          </span><span style="color: #CE9178">&#39;&lt;div id=&quot;app&quot;&gt;&#39;</span><span style="color: #D4D4D4">,</span></span>
<span class="line"><span style="color: #D4D4D4">          </span><span style="color: #CE9178">&#39;&lt;div id=&quot;app&quot;&gt;&#39;</span><span style="color: #D4D4D4"> +</span></span>
<span class="line"><span style="color: #D4D4D4">            </span><span style="color: #9CDCFE">body</span><span style="color: #D4D4D4">.</span><span style="color: #9CDCFE">html</span><span style="color: #D4D4D4"> +</span></span>
<span class="line"><span style="color: #D4D4D4">            </span><span style="color: #CE9178">`&lt;script&gt;__SSR_STATE__ = </span><span style="color: #569CD6">${</span><span style="color: #DCDCAA">serialize</span><span style="color: #D4D4D4">(</span><span style="color: #9CDCFE">route</span><span style="color: #D4D4D4">.</span><span style="color: #9CDCFE">ssrState</span><span style="color: #D4D4D4">)</span><span style="color: #569CD6">}</span><span style="color: #CE9178">&lt;/script&gt;`</span></span>
<span class="line"><span style="color: #D4D4D4">        )</span></span>
<span class="line"><span style="color: #D4D4D4">    }</span></span>
<span class="line"><span style="color: #D4D4D4">  } </span><span style="color: #C586C0">catch</span><span style="color: #D4D4D4"> (</span><span style="color: #9CDCFE">e</span><span style="color: #D4D4D4">) {</span></span>
<span class="line"><span style="color: #D4D4D4">    </span><span style="color: #9CDCFE">console</span><span style="color: #D4D4D4">.</span><span style="color: #DCDCAA">error</span><span style="color: #D4D4D4">(</span><span style="color: #9CDCFE">e</span><span style="color: #D4D4D4">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D4D4D4">    </span><span style="color: #C586C0">return</span><span style="color: #D4D4D4"> {</span></span>
<span class="line"><span style="color: #D4D4D4">      </span><span style="color: #9CDCFE">statusCode:</span><span style="color: #D4D4D4"> </span><span style="color: #B5CEA8">500</span><span style="color: #D4D4D4">,</span></span>
<span class="line"><span style="color: #D4D4D4">      </span><span style="color: #9CDCFE">body:</span><span style="color: #D4D4D4"> </span><span style="color: #C586C0">import</span><span style="color: #D4D4D4">.</span><span style="color: #9CDCFE">meta</span><span style="color: #D4D4D4">.</span><span style="color: #9CDCFE">env</span><span style="color: #D4D4D4">.</span><span style="color: #4FC1FF">DEV</span><span style="color: #D4D4D4"> &amp;&amp; </span><span style="color: #9CDCFE">e</span><span style="color: #D4D4D4"> </span><span style="color: #569CD6">instanceof</span><span style="color: #D4D4D4"> </span><span style="color: #4EC9B0">Error</span><span style="color: #D4D4D4"> ? </span><span style="color: #9CDCFE">e</span><span style="color: #D4D4D4">.</span><span style="color: #9CDCFE">message</span><span style="color: #D4D4D4"> : </span><span style="color: #CE9178">&#39;&#39;</span></span>
<span class="line"><span style="color: #D4D4D4">    }</span></span>
<span class="line"><span style="color: #D4D4D4">  }</span></span>
<span class="line"><span style="color: #D4D4D4">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #569CD6">function</span><span style="color: #D4D4D4"> </span><span style="color: #DCDCAA">serialize</span><span style="color: #D4D4D4">(</span><span style="color: #9CDCFE">data</span><span style="color: #D4D4D4">) {</span></span>
<span class="line"><span style="color: #D4D4D4">  </span><span style="color: #C586C0">return</span><span style="color: #D4D4D4"> </span><span style="color: #4FC1FF">JSON</span><span style="color: #D4D4D4">.</span><span style="color: #DCDCAA">stringify</span><span style="color: #D4D4D4">(</span><span style="color: #9CDCFE">data</span><span style="color: #D4D4D4">).</span><span style="color: #DCDCAA">replace</span><span style="color: #D4D4D4">(</span><span style="color: #D16969">/&lt;/</span><span style="color: #569CD6">g</span><span style="color: #D4D4D4">, </span><span style="color: #CE9178">&#39;</span><span style="color: #D7BA7D">\\</span><span style="color: #CE9178">u003C&#39;</span><span style="color: #D4D4D4">).</span><span style="color: #DCDCAA">replace</span><span style="color: #D4D4D4">(</span><span style="color: #D16969">/&gt;/</span><span style="color: #569CD6">g</span><span style="color: #D4D4D4">, </span><span style="color: #CE9178">&#39;</span><span style="color: #D7BA7D">\\</span><span style="color: #CE9178">u003E&#39;</span><span style="color: #D4D4D4">)</span></span>
<span class="line"><span style="color: #D4D4D4">}</span></span></code></pre>
</div><h2 id="client-entry-point">Client Entry Point</h2>

<div class="my-5">
  <div class="text-white bg-zinc-800 rounded-t py-1 px-3">src/main.js</div>
  <pre class="not-prose overflow-auto p-4 leading-normal rounded-b" style="background-color: #1E1E1E" tabindex="0"><code><span class="line"><span style="color: #C586C0">import</span><span style="color: #D4D4D4"> </span><span style="color: #CE9178">&#39;./app.css&#39;</span></span>
<span class="line"><span style="color: #C586C0">import</span><span style="color: #D4D4D4"> { </span><span style="color: #9CDCFE">ClientApp</span><span style="color: #D4D4D4"> } </span><span style="color: #C586C0">from</span><span style="color: #D4D4D4"> </span><span style="color: #CE9178">&#39;svelte-pilot&#39;</span></span>
<span class="line"><span style="color: #C586C0">import</span><span style="color: #D4D4D4"> </span><span style="color: #9CDCFE">router</span><span style="color: #D4D4D4"> </span><span style="color: #C586C0">from</span><span style="color: #D4D4D4"> </span><span style="color: #CE9178">&#39;./router&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #9CDCFE">router</span><span style="color: #D4D4D4">.</span><span style="color: #DCDCAA">start</span><span style="color: #D4D4D4">(</span></span>
<span class="line"><span style="color: #D4D4D4">  () </span><span style="color: #569CD6">=&gt;</span><span style="color: #D4D4D4"> {</span></span>
<span class="line"><span style="color: #D4D4D4">    </span><span style="color: #569CD6">new</span><span style="color: #D4D4D4"> </span><span style="color: #DCDCAA">ClientApp</span><span style="color: #D4D4D4">({</span></span>
<span class="line"><span style="color: #D4D4D4">      </span><span style="color: #9CDCFE">target:</span><span style="color: #D4D4D4"> </span><span style="color: #9CDCFE">document</span><span style="color: #D4D4D4">.</span><span style="color: #DCDCAA">getElementById</span><span style="color: #D4D4D4">(</span><span style="color: #CE9178">&#39;app&#39;</span><span style="color: #D4D4D4">),</span></span>
<span class="line"><span style="color: #D4D4D4">      </span><span style="color: #9CDCFE">hydrate:</span><span style="color: #D4D4D4"> </span><span style="color: #569CD6">true</span><span style="color: #D4D4D4">,</span></span>
<span class="line"><span style="color: #D4D4D4">      </span><span style="color: #9CDCFE">props:</span><span style="color: #D4D4D4"> { </span><span style="color: #9CDCFE">router</span><span style="color: #D4D4D4"> }</span></span>
<span class="line"><span style="color: #D4D4D4">    })</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D4D4D4">    </span><span style="color: #569CD6">delete</span><span style="color: #D4D4D4"> </span><span style="color: #9CDCFE">window</span><span style="color: #D4D4D4">.</span><span style="color: #9CDCFE">__SSR_STATE__</span></span>
<span class="line"><span style="color: #D4D4D4">  },</span></span>
<span class="line"><span style="color: #D4D4D4">  {</span></span>
<span class="line"><span style="color: #D4D4D4">    </span><span style="color: #9CDCFE">ssrState:</span><span style="color: #D4D4D4"> </span><span style="color: #9CDCFE">window</span><span style="color: #D4D4D4">.</span><span style="color: #9CDCFE">__SSR_STATE__</span></span>
<span class="line"><span style="color: #D4D4D4">  }</span></span>
<span class="line"><span style="color: #D4D4D4">)</span></span></code></pre>
</div><h2 id="build-configuration">Build Configuration</h2>
<p>Configure the <code>hydratable</code> option of Svelte to <code>true</code> in <code>vite.config.js</code>:</p>

<div class="my-5">
  <div class="text-white bg-zinc-800 rounded-t py-1 px-3">vite.config.js</div>
  <pre class="not-prose overflow-auto p-4 leading-normal rounded-b" style="background-color: #1E1E1E" tabindex="0"><code><span class="line"><span style="color: #C586C0">import</span><span style="color: #D4D4D4"> { </span><span style="color: #9CDCFE">defineConfig</span><span style="color: #D4D4D4"> } </span><span style="color: #C586C0">from</span><span style="color: #D4D4D4"> </span><span style="color: #CE9178">&#39;vite&#39;</span></span>
<span class="line"><span style="color: #C586C0">import</span><span style="color: #D4D4D4"> { </span><span style="color: #9CDCFE">svelte</span><span style="color: #D4D4D4"> } </span><span style="color: #C586C0">from</span><span style="color: #D4D4D4"> </span><span style="color: #CE9178">&#39;@sveltejs/vite-plugin-svelte&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #6A9955">// https://vitejs.dev/config/</span></span>
<span class="line"><span style="color: #C586C0">export</span><span style="color: #D4D4D4"> </span><span style="color: #C586C0">default</span><span style="color: #D4D4D4"> </span><span style="color: #DCDCAA">defineConfig</span><span style="color: #D4D4D4">({</span></span>
<span class="line"><span style="color: #D4D4D4">  </span><span style="color: #9CDCFE">plugins:</span><span style="color: #D4D4D4"> [</span></span>
<span class="line"><span style="color: #D4D4D4">    </span><span style="color: #DCDCAA">svelte</span><span style="color: #D4D4D4">({</span></span>
<span class="line"><span style="color: #D4D4D4">      </span><span style="color: #9CDCFE">compilerOptions:</span><span style="color: #D4D4D4"> {</span></span>
<span class="line"><span style="color: #D4D4D4">        </span><span style="color: #9CDCFE">hydratable:</span><span style="color: #D4D4D4"> </span><span style="color: #569CD6">true</span></span>
<span class="line"><span style="color: #D4D4D4">      }</span></span>
<span class="line"><span style="color: #D4D4D4">    })</span></span>
<span class="line"><span style="color: #D4D4D4">  ]</span></span>
<span class="line"><span style="color: #D4D4D4">})</span></span></code></pre>
</div><p>Now, run <code>node ssr-dev-server.js</code> in the command line to start the HTTP service for the development environment and visit <code>http://localhost:5173</code> to see the effect.</p>
<p>We can observe the existence of a <a href="https://en.wikipedia.org/wiki/Flash_of_unstyled_content">FOUC (Flash of Unstyled Content)</a> issue. In production mode, for projects that use Tailwind CSS, this can be resolved by setting the Vite configuration option <code>build.cssCodeSplit</code> to <code>true</code>. If your CSS is too large and needs to be loaded on demand, you can read the Vite compiled <a href="https://vitejs.dev/guide/ssr.html#generating-preload-directives">ssr-manifest.json</a> file, and then insert the CSS files required for the current page into the HTML during server-side rendering. A specific implementation can be referred to in the <a href="https://github.com/svelte-pilot/svelte-pilot-template">svelte-pilot-template</a> project.</p>
<h2 id="server-entry-point">Server Entry Point</h2>
<p>Next, we create an entry file <code>src/server.js</code> for the production environment:</p>

<div class="my-5">
  <div class="text-white bg-zinc-800 rounded-t py-1 px-3">src/server.js</div>
  <pre class="not-prose overflow-auto p-4 leading-normal rounded-b" style="background-color: #1E1E1E" tabindex="0"><code><span class="line"><span style="color: #C586C0">import</span><span style="color: #D4D4D4"> { </span><span style="color: #9CDCFE">createServer</span><span style="color: #D4D4D4"> } </span><span style="color: #C586C0">from</span><span style="color: #D4D4D4"> </span><span style="color: #CE9178">&#39;http&#39;</span></span>
<span class="line"><span style="color: #C586C0">import</span><span style="color: #D4D4D4"> </span><span style="color: #9CDCFE">sirv</span><span style="color: #D4D4D4"> </span><span style="color: #C586C0">from</span><span style="color: #D4D4D4"> </span><span style="color: #CE9178">&#39;sirv&#39;</span></span>
<span class="line"><span style="color: #C586C0">import</span><span style="color: #D4D4D4"> </span><span style="color: #9CDCFE">render</span><span style="color: #D4D4D4"> </span><span style="color: #C586C0">from</span><span style="color: #D4D4D4"> </span><span style="color: #CE9178">&#39;./render&#39;</span></span>
<span class="line"><span style="color: #C586C0">import</span><span style="color: #D4D4D4"> </span><span style="color: #9CDCFE">template</span><span style="color: #D4D4D4"> </span><span style="color: #C586C0">from</span><span style="color: #D4D4D4"> </span><span style="color: #CE9178">&#39;../dist/client/index.html?raw&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #569CD6">const</span><span style="color: #D4D4D4"> </span><span style="color: #4FC1FF">PORT</span><span style="color: #D4D4D4"> = </span><span style="color: #DCDCAA">Number</span><span style="color: #D4D4D4">(</span><span style="color: #9CDCFE">process</span><span style="color: #D4D4D4">.</span><span style="color: #9CDCFE">env</span><span style="color: #D4D4D4">.</span><span style="color: #4FC1FF">PORT</span><span style="color: #D4D4D4">) || </span><span style="color: #B5CEA8">5173</span></span>
<span class="line"><span style="color: #569CD6">const</span><span style="color: #D4D4D4"> </span><span style="color: #4FC1FF">serve</span><span style="color: #D4D4D4"> = </span><span style="color: #DCDCAA">sirv</span><span style="color: #D4D4D4">(</span><span style="color: #CE9178">&#39;../client&#39;</span><span style="color: #D4D4D4">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #DCDCAA">createServer</span><span style="color: #D4D4D4">(</span><span style="color: #569CD6">async</span><span style="color: #D4D4D4"> (</span><span style="color: #9CDCFE">req</span><span style="color: #D4D4D4">, </span><span style="color: #9CDCFE">res</span><span style="color: #D4D4D4">) </span><span style="color: #569CD6">=&gt;</span><span style="color: #D4D4D4"> {</span></span>
<span class="line"><span style="color: #D4D4D4">  </span><span style="color: #9CDCFE">console</span><span style="color: #D4D4D4">.</span><span style="color: #DCDCAA">log</span><span style="color: #D4D4D4">(</span><span style="color: #9CDCFE">req</span><span style="color: #D4D4D4">.</span><span style="color: #9CDCFE">url</span><span style="color: #D4D4D4">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D4D4D4">  </span><span style="color: #DCDCAA">serve</span><span style="color: #D4D4D4">(</span><span style="color: #9CDCFE">req</span><span style="color: #D4D4D4">, </span><span style="color: #9CDCFE">res</span><span style="color: #D4D4D4">, </span><span style="color: #569CD6">async</span><span style="color: #D4D4D4"> () </span><span style="color: #569CD6">=&gt;</span><span style="color: #D4D4D4"> {</span></span>
<span class="line"><span style="color: #D4D4D4">    </span><span style="color: #569CD6">const</span><span style="color: #D4D4D4"> {</span></span>
<span class="line"><span style="color: #D4D4D4">      </span><span style="color: #4FC1FF">statusCode</span><span style="color: #D4D4D4"> = </span><span style="color: #B5CEA8">200</span><span style="color: #D4D4D4">,</span></span>
<span class="line"><span style="color: #D4D4D4">      </span><span style="color: #4FC1FF">statusMessage</span><span style="color: #D4D4D4">,</span></span>
<span class="line"><span style="color: #D4D4D4">      </span><span style="color: #4FC1FF">headers</span><span style="color: #D4D4D4">,</span></span>
<span class="line"><span style="color: #D4D4D4">      </span><span style="color: #4FC1FF">body</span></span>
<span class="line"><span style="color: #D4D4D4">    } = </span><span style="color: #C586C0">await</span><span style="color: #D4D4D4"> </span><span style="color: #DCDCAA">render</span><span style="color: #D4D4D4">({</span></span>
<span class="line"><span style="color: #D4D4D4">      </span><span style="color: #9CDCFE">url:</span><span style="color: #D4D4D4"> </span><span style="color: #9CDCFE">req</span><span style="color: #D4D4D4">.</span><span style="color: #9CDCFE">url</span><span style="color: #D4D4D4">,</span></span>
<span class="line"><span style="color: #D4D4D4">      </span><span style="color: #9CDCFE">template</span><span style="color: #D4D4D4">,</span></span>
<span class="line"><span style="color: #D4D4D4">      </span><span style="color: #9CDCFE">headers:</span><span style="color: #D4D4D4"> </span><span style="color: #9CDCFE">req</span><span style="color: #D4D4D4">.</span><span style="color: #9CDCFE">headers</span></span>
<span class="line"><span style="color: #D4D4D4">    })</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D4D4D4">    </span><span style="color: #C586C0">if</span><span style="color: #D4D4D4"> (</span><span style="color: #9CDCFE">statusMessage</span><span style="color: #D4D4D4">) {</span></span>
<span class="line"><span style="color: #D4D4D4">      </span><span style="color: #9CDCFE">res</span><span style="color: #D4D4D4">.</span><span style="color: #9CDCFE">statusMessage</span><span style="color: #D4D4D4"> = </span><span style="color: #9CDCFE">statusMessage</span></span>
<span class="line"><span style="color: #D4D4D4">    }</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D4D4D4">    </span><span style="color: #9CDCFE">res</span><span style="color: #D4D4D4">.</span><span style="color: #DCDCAA">writeHead</span><span style="color: #D4D4D4">(</span><span style="color: #9CDCFE">statusCode</span><span style="color: #D4D4D4">, </span><span style="color: #9CDCFE">headers</span><span style="color: #D4D4D4">)</span></span>
<span class="line"><span style="color: #D4D4D4">    </span><span style="color: #9CDCFE">res</span><span style="color: #D4D4D4">.</span><span style="color: #DCDCAA">end</span><span style="color: #D4D4D4">(</span><span style="color: #9CDCFE">body</span><span style="color: #D4D4D4">)</span></span>
<span class="line"><span style="color: #D4D4D4">  })</span></span>
<span class="line"><span style="color: #D4D4D4">}).</span><span style="color: #DCDCAA">listen</span><span style="color: #D4D4D4">(</span><span style="color: #4FC1FF">PORT</span><span style="color: #D4D4D4">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #9CDCFE">console</span><span style="color: #D4D4D4">.</span><span style="color: #DCDCAA">log</span><span style="color: #D4D4D4">(</span><span style="color: #CE9178">`Server running at http://localhost:</span><span style="color: #569CD6">${</span><span style="color: #4FC1FF">PORT</span><span style="color: #569CD6">}</span><span style="color: #CE9178">`</span><span style="color: #D4D4D4">)</span></span></code></pre>
</div><p>Install dependencies:</p>
<pre class="not-prose overflow-auto p-4 leading-normal rounded" style="background-color: #1E1E1E" tabindex="0"><code><span class="line"><span style="color: #DCDCAA">npm</span><span style="color: #D4D4D4"> </span><span style="color: #CE9178">i</span><span style="color: #D4D4D4"> </span><span style="color: #CE9178">sirv</span></span></code></pre><p>Then, we add SSR related commands in <code>package.json</code>:</p>
<pre class="not-prose overflow-auto p-4 leading-normal rounded" style="background-color: #1E1E1E" tabindex="0"><code><span class="line"><span style="color: #D4D4D4">{</span></span>
<span class="line"><span style="color: #D4D4D4">  </span><span style="color: #9CDCFE">&quot;scripts&quot;</span><span style="color: #D4D4D4">: {</span></span>
<span class="line"><span style="color: #D4D4D4">    </span><span style="color: #9CDCFE">&quot;dev:ssr&quot;</span><span style="color: #D4D4D4">: </span><span style="color: #CE9178">&quot;node ssr-dev-server.js&quot;</span><span style="color: #D4D4D4">,</span></span>
<span class="line"><span style="color: #D4D4D4">    </span><span style="color: #9CDCFE">&quot;build:ssr&quot;</span><span style="color: #D4D4D4">: </span><span style="color: #CE9178">&quot;vite build --outDir dist/client &amp;&amp; vite build --ssr src/server.js --outDir dist/server&quot;</span><span style="color: #D4D4D4">,</span></span>
<span class="line"><span style="color: #D4D4D4">    </span><span style="color: #9CDCFE">&quot;start:ssr&quot;</span><span style="color: #D4D4D4">: </span><span style="color: #CE9178">&quot;cd dist/server &amp;&amp; node server.js&quot;</span></span>
<span class="line"><span style="color: #D4D4D4">  }</span></span>
<span class="line"><span style="color: #D4D4D4">}</span></span></code></pre><p>Now, we can run <code>npm run build:ssr</code> in the command line to build the code for the production environment, and then run <code>npm run start:ssr</code> to start the HTTP service for the production environment, and visit <code>http://localhost:5173</code> to see the effect.</p>
<h2 id="loading-data">Loading Data</h2>
<p>We can export a <code>load</code> function in the view component to load data. For example:</p>
<pre class="not-prose overflow-auto p-4 leading-normal rounded" style="background-color: #1E1E1E" tabindex="0"><code><span class="line"><span style="color: #808080">&lt;</span><span style="color: #569CD6">script</span><span style="color: #D4D4D4"> </span><span style="color: #9CDCFE">context</span><span style="color: #D4D4D4">=</span><span style="color: #CE9178">&quot;module&quot;</span><span style="color: #808080">&gt;</span></span>
<span class="line"><span style="color: #D4D4D4">  </span><span style="color: #C586C0">export</span><span style="color: #D4D4D4"> </span><span style="color: #569CD6">async</span><span style="color: #D4D4D4"> </span><span style="color: #569CD6">function</span><span style="color: #D4D4D4"> </span><span style="color: #DCDCAA">load</span><span style="color: #D4D4D4">() {</span></span>
<span class="line"><span style="color: #D4D4D4">    </span><span style="color: #C586C0">return</span><span style="color: #D4D4D4"> {</span></span>
<span class="line"><span style="color: #D4D4D4">      </span><span style="color: #9CDCFE">user:</span><span style="color: #D4D4D4"> </span><span style="color: #CE9178">&#39;World&#39;</span></span>
<span class="line"><span style="color: #D4D4D4">    }</span></span>
<span class="line"><span style="color: #D4D4D4">  }</span></span>
<span class="line"><span style="color: #808080">&lt;/</span><span style="color: #569CD6">script</span><span style="color: #808080">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #808080">&lt;</span><span style="color: #569CD6">script</span><span style="color: #808080">&gt;</span></span>
<span class="line"><span style="color: #D4D4D4">  </span><span style="color: #C586C0">export</span><span style="color: #D4D4D4"> </span><span style="color: #569CD6">let</span><span style="color: #D4D4D4"> </span><span style="color: #9CDCFE">user</span></span>
<span class="line"><span style="color: #808080">&lt;/</span><span style="color: #569CD6">script</span><span style="color: #808080">&gt;</span></span>
<span class="line"></span>
<span class="line"><span style="color: #808080">&lt;</span><span style="color: #569CD6">h1</span><span style="color: #808080">&gt;</span><span style="color: #D4D4D4">Hello </span><span style="color: #569CD6">{</span><span style="color: #9CDCFE">user</span><span style="color: #569CD6">}</span><span style="color: #D4D4D4">!</span><span style="color: #808080">&lt;/</span><span style="color: #569CD6">h1</span><span style="color: #808080">&gt;</span></span></code></pre><p>The <code>load</code> function is called during server-side rendering, and the returned data is passed to the view component. In <code>render.js</code>, we embedded the data into HTML, and during client-side rendering, we provide the data to the router for hydration.</p>
<p>The <code>load</code> function accepts three parameters:</p>
<ul>
<li><code>props</code>: The <code>props</code> object of the view component.</li>
<li><code>route</code>: The current <a href="router#route">route object</a>.</li>
<li><code>context</code>: A custom context object. Passed as the second parameter when calling <a href="router#routerhandleserver">router.handleServer()</a>. You can store information like <code>headers</code>, <code>cookies</code>, etc., of the current request in the <code>context</code> object and also set the response’s <code>statusCode</code>, <code>statusMessage</code>, <code>headers</code>, etc. The specific implementation can be referred to in the <a href="https://github.com/svelte-pilot/svelte-pilot-template">svelte-pilot-template</a> project, details of which are not reiterated here.</li>
</ul>
<h3 id="client-side-calling-the-load-function">Client-Side Calling the load Function</h3>
<p>When we use the HTML5 History API for routing on the client side, the <code>load</code> function of the view component is not called by default, leading to a lack of data during client-side rendering. We have three solutions:</p>
<h4 id="not-using-html5-history-api">Not Using HTML5 History API</h4>
<ul>
<li>Avoid using <code>router.push()</code> and <code>router.replace()</code>, and use <code>location.href</code> for routing instead;</li>
<li>Set the <a href="link#setting-global-default-properties">default <code>method</code></a> of the <code>&lt;Link&gt;</code> component to <code>null</code> to prevent it from invoking the HTML5 History API. Alternatively, use the <code>&lt;a&gt;</code> tag directly.</li>
</ul>
<h4 id="using--label-to-monitor-component-props">Using <code>$:</code> Label to Monitor Component props</h4>
<p>This is the common practice with regular Svelte components—monitor the component props, and load new data with client-side code when they change.</p>
<h4 id="setting-callloadonclient-attribute">Setting callLoadOnClient Attribute</h4>
<p>Set the <a href="router#callloadonclient">callLoadOnClient</a> parameter to <code>true</code> when instantiating the Router. This way, the view component’s <code>load</code> function will be called when using the HTML5 History API for routing on the client side. But as the server and client have significant differences in data retrieval, request processing, and response handling, we need to implement compatible <code>context</code> objects for both. The server’s <code>context</code> object has already been mentioned; for the client, set the <code>clientContext</code> attribute in the second parameter of <a href="router#start">router.start()</a>.</p>
<p>Besides setting the <code>callLoadOnClient</code> attribute globally, we can also set the <code>callOnClient</code> attribute for each <code>load</code> function individually. This way, some view components can call the <code>load</code> function while others do not. For instance, if you need fine-grained control over the UI style when loading data, you can set <code>load.callOnClient = false</code> to prevent the current view component from calling the <code>load</code> function on the client side, and then use the <code>$:</code> label to monitor component props to load data.</p>
<p>The <code>load</code> function also has a <code>cacheKey</code> attribute that can be set to an array, the elements of which are property names from the component&#39;s props object. When the prop values specified in the <code>cacheKey</code> array of the route after the jump are all the same as the current route, the <code>load</code> function will not be called, and the current cached data will be used directly, avoiding unnecessary data loading. If the <code>cacheKey</code> attribute is not set, it defaults to all property names in the props object.</p>
<p>Example:</p>
<pre class="not-prose overflow-auto p-4 leading-normal rounded" style="background-color: #1E1E1E" tabindex="0"><code><span class="line"><span style="color: #C586C0">export</span><span style="color: #D4D4D4"> </span><span style="color: #569CD6">async</span><span style="color: #D4D4D4"> </span><span style="color: #569CD6">function</span><span style="color: #D4D4D4"> </span><span style="color: #DCDCAA">load</span><span style="color: #D4D4D4">({ </span><span style="color: #9CDCFE">id</span><span style="color: #D4D4D4"> }, </span><span style="color: #9CDCFE">route</span><span style="color: #D4D4D4">, </span><span style="color: #9CDCFE">ctx</span><span style="color: #D4D4D4">) {</span></span>
<span class="line"><span style="color: #D4D4D4">  </span><span style="color: #569CD6">const</span><span style="color: #D4D4D4"> </span><span style="color: #4FC1FF">user</span><span style="color: #D4D4D4"> = </span><span style="color: #C586C0">await</span><span style="color: #D4D4D4"> </span><span style="color: #9CDCFE">ctx</span><span style="color: #D4D4D4">.</span><span style="color: #9CDCFE">api</span><span style="color: #D4D4D4">.</span><span style="color: #DCDCAA">get</span><span style="color: #D4D4D4">(</span><span style="color: #CE9178">&#39;/user/&#39;</span><span style="color: #D4D4D4"> + </span><span style="color: #9CDCFE">id</span><span style="color: #D4D4D4">)</span></span>
<span class="line"></span>
<span class="line"><span style="color: #D4D4D4">  </span><span style="color: #C586C0">if</span><span style="color: #D4D4D4"> (!</span><span style="color: #9CDCFE">user</span><span style="color: #D4D4D4">) {</span></span>
<span class="line"><span style="color: #D4D4D4">    </span><span style="color: #6A9955">/*</span></span>
<span class="line"><span style="color: #6A9955">      The rewrite() method needs to be implemented separately for both the server and the client.</span></span>
<span class="line"><span style="color: #6A9955">      On the server-side, we can call router.handleServer(&#39;/404&#39;) to render the 404 page.</span></span>
<span class="line"><span style="color: #6A9955">      On the client-side, we can call router.handleClient(&#39;/404&#39;) to render the 404 page.</span></span>
<span class="line"><span style="color: #6A9955">    */</span></span>
<span class="line"><span style="color: #D4D4D4">    </span><span style="color: #9CDCFE">ctx</span><span style="color: #D4D4D4">.</span><span style="color: #DCDCAA">rewrite</span><span style="color: #D4D4D4">(</span><span style="color: #CE9178">&#39;/404&#39;</span><span style="color: #D4D4D4">)</span></span>
<span class="line"><span style="color: #D4D4D4">    </span><span style="color: #C586C0">return</span></span>
<span class="line"><span style="color: #D4D4D4">  } </span><span style="color: #C586C0">else</span><span style="color: #D4D4D4"> {</span></span>
<span class="line"><span style="color: #D4D4D4">    </span><span style="color: #C586C0">return</span><span style="color: #D4D4D4"> { </span><span style="color: #9CDCFE">user</span><span style="color: #D4D4D4"> }</span></span>
<span class="line"><span style="color: #D4D4D4">  }</span></span>
<span class="line"><span style="color: #D4D4D4">}</span></span>
<span class="line"></span>
<span class="line"><span style="color: #9CDCFE">load</span><span style="color: #D4D4D4">.</span><span style="color: #9CDCFE">callOnClient</span><span style="color: #D4D4D4"> = </span><span style="color: #569CD6">true</span></span>
<span class="line"><span style="color: #9CDCFE">load</span><span style="color: #D4D4D4">.</span><span style="color: #9CDCFE">cacheKey</span><span style="color: #D4D4D4"> = [</span><span style="color: #CE9178">&#39;id&#39;</span><span style="color: #D4D4D4">]</span></span></code></pre><p>By this point, you should have a basic understanding of implementing server-side rendering using Svelte Pilot. If you need to deploy on a serverless platform or generate a static website (Static-Site Generation), it can be achieved with minor modifications. You can directly use or refer to the <a href="https://github.com/svelte-pilot/svelte-pilot-template">svelte-pilot-template</a> project.</p>
<!-- HTML_TAG_END --></article> <div class="mt-5 text-slate-600"><a href="https://github.com/svelte-pilot/svelte-pilot.github.io/edit/main/docs/en/ssr.md">Edit this page on GitHub</a></div> <div class="flex justify-between border-t border-t-slate-300 mt-6 py-3"><div><a href="/en/routing" class="text-[#FF3E00] ">← Routing</a></div> <div><a href="/en/template" class="text-[#FF3E00] ">Template →</a></div></div></main> <aside class="sr-only xl:not-sr-only xl:w-64 xl:px-8 xl:shrink-0"><div class="sticky top-0"><h2 class="font-semibold text-slate-500 tracking-widest uppercase pt-8 pb-4">On this page</h2> <ul><li class="my-2"><a href="#server-side-rendering" class="text-slate-800">Server-Side Rendering</a> </li><li class="my-2"><a href="#code-structure" class="text-slate-800">Code Structure</a> </li><li class="my-2"><a href="#development-server" class="text-slate-800">Development Server</a> </li><li class="my-2"><a href="#server-side-renderer" class="text-slate-800">Server-Side Renderer</a> </li><li class="my-2"><a href="#client-entry-point" class="text-slate-800">Client Entry Point</a> </li><li class="my-2"><a href="#build-configuration" class="text-slate-800">Build Configuration</a> </li><li class="my-2"><a href="#server-entry-point" class="text-slate-800">Server Entry Point</a> </li><li class="my-2"><a href="#loading-data" class="text-slate-800">Loading Data</a> </li></ul></div></aside></div></body>
</html>
